<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareerPath | Ciclo de Estudos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <style>
        /* --- ESTILO BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: #2c3e50; min-height: 100vh; }
        .app-shell { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* --- NAVEGAÇÃO PRINCIPAL --- */
        .main-navigation { display: flex; gap: 20px; margin-bottom: 30px; padding-left: 10px; border-bottom: 1px solid #dee2e6; margin-top: 20px; }
        .nav-tab { background: none; border: none; color: #6c757d; font-size: 18px; font-weight: 500; cursor: pointer; padding-bottom: 12px; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .nav-tab:hover { color: #003366; }
        .nav-tab.active { color: #003366; font-weight: 600; border-bottom-color: #003366; }
        .view { display: none; }
        .view.active { display: block; }
        
        /* --- TELAS DE TELA CHEIA (LOGIN, CARREGANDO) --- */
        .fullscreen-view { text-align: center; padding: 60px 20px; background: white; border-radius: 12px; max-width: 550px; margin: 60px auto; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        .fullscreen-view h2 { margin-bottom: 15px; font-size: 1.8em; color: #003366; }
        .fullscreen-view p { margin-bottom: 30px; color: #6c757d; line-height: 1.6; }
        #login-button { display: inline-flex; align-items: center; gap: 15px; padding: 12px 28px; font-size: 16px; font-weight: 500; background: #4285F4; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        #login-button:hover { background-color: #357ae8; }
        #login-button svg { width: 20px; height: 20px; }

        /* --- ESTILOS DE CONTEÚDO PRINCIPAL --- */
        .content-wrapper, #current-view .container { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        .page-header { font-size: 2em; color: #003366; font-weight: 600; margin-bottom: 30px; display: flex; align-items: center; gap: 15px; padding-left: 10px; }
        .page-header .material-icons-outlined { font-size: 1.2em; }

        #current-view h1 { display: flex; justify-content: center; align-items: center; gap: 12px; text-align: center; color: #003366; margin-bottom: 30px; font-size: 2.2em; font-weight: 600; }
        .cycle-icon { width: 1.1em; height: 1.1em; fill: #ff6f61; }

        /* --- BOTÕES E INPUTS --- */
        button { background-color: #003366; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; font-family: 'Poppins', sans-serif; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 51, 102, 0.2); }
        button:disabled { background-color: #aeb8c2; opacity: 1; cursor: not-allowed; transform: none; box-shadow: none; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; font-size: 16px; font-family: 'Poppins', sans-serif; transition: border-color 0.3s, box-shadow 0.3s; }
        input[type="text"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: #ff6f61; box-shadow: 0 0 0 3px rgba(255, 111, 97, 0.2); }
        .remove-btn, button.secondary { background-color: #e9ecef; color: #495057; }
        .remove-btn:hover, button.secondary:hover { background-color: #dee2e6; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        button.danger { background-color: #e74c3c; }
        button.danger:hover { box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3); }

        /* --- GRÁFICO E STATS --- */
        .chart-container { background-color: #fff; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; margin: 20px 0; display: flex; justify-content: center; position: relative; }
        #wheelChart text { fill: #6c757d; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: #fff; border: 1px solid #e9ecef; color: #2c3e50; padding: 20px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: 600; color: #003366; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; color: #6c757d; }

        /* --- LISTA DE DISCIPLINAS --- */
        .discipline-list { margin: 20px 0; }
        .discipline-item { display: flex; align-items: center; gap: 15px; padding: 15px; margin: 10px 0; background: #fdfdff; border-radius: 10px; border: 1px solid #e9ecef; transition: all 0.3s; flex-wrap: wrap; border-left: 5px solid; }
        .discipline-item.completed { border-left-color: #28a745 !important; background-color: #f6fff8; }
        .discipline-name-group { flex: 1; display: flex; align-items: center; gap: 10px; font-weight: 500; min-width: 150px; }
        .edit-btn { background: none; border: none; color: #6c757d; cursor: pointer; padding: 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .edit-btn:hover { background-color: #e9ecef; color: #003366; }
        .timer-btn { background-color: #28a745; font-size: 14px; padding: 10px 16px; }
        .timer-btn.stop { background-color: #ff6f61; }
        
        /* --- CALENDÁRIO --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .calendar-nav-group { display: flex; align-items: center; gap: 10px; }
        .calendar-title { color: #003366; font-weight: 600; text-align: center; flex-grow: 1; }
        .view-toggles { display: flex; }
        .view-toggles button { font-size: 14px; padding: 6px 12px; border-radius: 6px; background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; }
        .view-toggles button.active { background-color: #003366; color: white; border-color: #003366; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-header { text-align: center; font-weight: 600; color: #6c757d; font-size: 0.9em; padding-bottom: 10px; }
        .calendar-day { aspect-ratio: 1; border: 1px solid transparent; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; position: relative; font-size: 14px; }
        .calendar-day:hover { background-color: #f0f3f5; }
        .calendar-day.today { border-color: #ff6f61; }
        .calendar-day.selected { background-color: #003366; color: white; }
        .calendar-day.has-studies { font-weight: 600; }
        .calendar-day.has-studies::after { content: ''; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background-color: #003366; border-radius: 50%; }
        .calendar-day.selected.has-studies::after { background-color: #ff6f61; }
        .calendar-nav { background-color: #003366; }
        .calendar-summary { text-align: center; font-size: 1.1em; font-weight: 500; color: #003366; background-color: #e9f0f5; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
        .study-history { border-top: 1px solid #dee2e6; margin-top: 20px; padding-top: 20px; }
        .daily-total { font-size: 1.1em; font-weight: 600; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e9ecef; }
        .study-history-item { padding: 8px; margin-top: 5px; background: #fdfdff; border-left: 3px solid #003366; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .history-delete-btn { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 24px; text-align: center; padding: 0; }

        /* --- MODAIS E OUTROS --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; padding: 30px 40px; border-radius: 12px; text-align: center; max-width: 500px; width: 100%; box-shadow: 0 5px 25px rgba(0,0,0,0.2); animation: modal-appear 0.3s ease-out; }
        @keyframes modal-appear { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content h3 { color: #003366; margin-bottom: 15px; font-size: 1.6em; }
        .modal-content p { margin-bottom: 30px; color: #6c757d; font-size: 1.1em; line-height: 1.6; }
        .modal-buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .trophy-icon { width: 60px; height: 60px; margin: 0 auto 20px auto; fill: #ffc107; }
        .form-group-modal { margin-bottom: 15px; text-align: left; }
        .form-group-modal label { display: block; margin-bottom: 5px; font-weight: 500; }
        #cycle-selection-view { text-align: center; background: white; border-radius: 12px; padding: 40px 20px; max-width: 600px; margin: 40px auto; border: 1px solid #e9ecef; }
        .add-discipline-form { background: #f8f9fa; border: 1px solid #e9ecef; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .form-title { font-size: 1.2em; font-weight: 600; margin-bottom: 15px; color: #003366; }
        .input-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 10px; }
        .input-row .input-group { flex-grow: 1; }
        .time-input-container { display: flex; gap: 10px; align-items: flex-end; }
        .time-input-group { display: flex; flex-direction: column; align-items: center; }
        .time-input-group label { font-size: 0.8em; color: #666; margin-bottom: 4px; }
        .time-input-group input { width: 70px; text-align: center; }
        .time-input-separator { font-size: 1.5em; color: #999; padding-bottom: 10px; }
        
        @media (max-width: 600px) {
            .calendar-header { flex-direction: column; gap: 15px; }
            body { padding: 5px; }
            .app-shell { padding: 10px; }
            .content-wrapper, #current-view .container, .fullscreen-view { padding: 15px; }
            .page-header { font-size: 1.5em; }
            .add-discipline-form .input-row { flex-wrap: wrap; gap: 15px; }
            .add-discipline-form .input-group { width: 100%; min-width: 100%; }
            .add-discipline-form .time-input-container { flex-grow: 1; }
            .add-discipline-form button { flex-grow: 1; }
            .stats, #historyStats { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
            .main-navigation { display: flex; justify-content: space-around; padding: 0; gap: 0; }
            .nav-tab { flex-grow: 1; text-align: center; font-size: 15px; padding: 0 5px 12px 5px; }
        }
    </style>
</head>
<body>

    <div class="app-shell">
        <nav class="main-navigation" style="display: none;">
            <button class="nav-tab active" onclick="switchView('current')">Ciclo Atual</button>
            <button class="nav-tab" onclick="switchView('calendar')">Calendário</button>
            <button class="nav-tab" onclick="switchView('history')">Histórico</button>
        </nav>

        <div id="loading-view" class="view active fullscreen-view">
            <h2>Carregando...</h2>
            <p>Verificando sua conta CareerPath.</p>
        </div>

        <div id="login-view" class="view fullscreen-view">
            <h2>Bem-vindo ao seu Ciclo de Estudos</h2>
            <p>Faça login com sua conta Google para salvar e sincronizar seus ciclos de estudo na plataforma CareerPath.</p>
            <button id="login-button" onclick="signInWithGoogle()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.223,0-9.651-3.358-11.303-8H6.306C9.656,39.663,16.318,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.901,35.636,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                <span>Entrar com Google</span>
            </button>
        </div>

        <div id="cycle-selection-view" class="view">
            <h2>Selecione ou Crie um Ciclo</h2>
            <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                <label for="existingCycleSelector" style="display: block; margin-bottom: 8px; font-weight: 500;">Escolha um ciclo existente</label>
                <select id="existingCycleSelector"></select>
            </div>
            <button onclick="loadSelectedCycle()">Carregar Ciclo</button>
            <div style="margin: 25px 0; font-weight: bold; color: #999;">OU</div>
            <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                 <label for="newCycleNameInput" style="display: block; margin-bottom: 8px; font-weight: 500;">Crie um novo ciclo</label>
                 <input type="text" id="newCycleNameInput" placeholder="Ex: Trilha Front-End...">
            </div>
            <button onclick="createNewCycle()">Criar e Iniciar</button>
            <button class="danger" onclick="signOutUser()" style="margin-top: 30px;">Sair</button>
        </div>

        <div id="current-view" class="view">
            <div class="container">
                <h1 id="cycleTitle"></h1>
                <div id="main-content">
                    <div class="stats">
                        <div class="stat-card"><div class="stat-number" id="cycleCompletions">0</div><div class="stat-label">Vezes Concluído</div></div>
                        <div class="stat-card"><div class="stat-number" id="totalDisciplines">0</div><div class="stat-label">Disciplinas</div></div>
                        <div class="stat-card"><div class="stat-number" id="totalHours">0h</div><div class="stat-label">Horas Hoje</div></div>
                    </div>
                    
                    <div class="add-discipline-form">
                        <div class="form-title">Adicionar Nova Disciplina</div>
                        <div class="input-row">
                            <div class="input-group"><input type="text" id="disciplineInput" placeholder="Nome da disciplina..."></div>
                            <div class="time-input-container">
                                <div class="time-input-group">
                                    <label for="hoursInput">Horas</label>
                                    <input type="number" id="hoursInput" min="0" placeholder="HH" value="1">
                                </div>
                                <span class="time-input-separator">:</span>
                                <div class="time-input-group">
                                    <label for="minutesInput">Minutos</label>
                                    <input type="number" id="minutesInput" min="0" max="59" step="5" placeholder="MM" value="0">
                                </div>
                            </div>
                            <button onclick="addDiscipline()">Adicionar</button>
                        </div>
                    </div>

                    <div class="chart-container" id="chartContainer"><svg id="wheelChart" width="400" height="400" viewBox="0 0 400 400"></svg></div>
                    <div class="discipline-list" id="disciplinesList"></div>

                    <div id="mainControls" style="display:flex; flex-wrap: wrap; gap:10px; margin-top:30px; justify-content:center;">
                        <button class="secondary" onclick="returnToCycleSelection()">Trocar de Ciclo</button>
                        <button class="secondary" onclick="manuallyEndCycle()">Encerrar Ciclo</button>
                        <button class="danger" onclick="deleteCurrentCycle()">Apagar Ciclo Atual</button>
                        <button class="danger" onclick="signOutUser()">Sair</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="calendar-view" class="view">
            <header class="page-header"><span class="material-icons-outlined">calendar_today</span> Calendário de Estudos</header>
            <div class="content-wrapper">
                <div class="calendar-header">
                    <div class="calendar-nav-group">
                        <button class="calendar-nav" onclick="navigateCalendar(-1)">❮</button>
                        <h2 id="calendarTitle" class="calendar-title"></h2>
                        <button class="calendar-nav" onclick="navigateCalendar(1)">❯</button>
                    </div>
                    <div class="view-toggles">
                        <button id="view-toggle-month" class="active" onclick="setCalendarView('month')">Mês</button>
                        <button id="view-toggle-week" onclick="setCalendarView('week')">Semana</button>
                    </div>
                </div>
                <div id="calendar-summary" class="calendar-summary"></div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Dom</div><div class="calendar-day-header">Seg</div><div class="calendar-day-header">Ter</div><div class="calendar-day-header">Qua</div><div class="calendar-day-header">Qui</div><div class="calendar-day-header">Sex</div><div class="calendar-day-header">Sáb</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div id="selectedDateInfo" class="study-history" style="display: none;"></div>
            </div>
        </div>

        <div id="history-view" class="view">
            <header class="page-header"><span class="material-icons-outlined">bar_chart</span> Histórico de Estudos</header>
            <div class="content-wrapper">
                <select id="historyCycleSelector" onchange="updateHistoryStats()"></select>
                <div id="historyStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;"></div>
            </div>
        </div>
    </div>

    <div id="completionModal" class="modal-overlay"> <div class="modal-content"> <h3>Ciclo Concluído!</h3> <p>Parabéns! Você atingiu a meta de todas as disciplinas. O que deseja fazer agora?</p> <div class="modal-buttons"> <button class="secondary" onclick="handleContinueCycle()">Continuar Neste Ciclo</button> <button onclick="handleStartNewCycle()">Iniciar Novo Ciclo</button> </div> </div> </div>
    <div id="celebrationModal" class="modal-overlay"> <div class="modal-content"> <svg class="trophy-icon" viewBox="0 0 24 24"><path d="M20.2,4H22L19,2H5L2,4h1.8C4.4,4.8,5,5.9,5,7c0,1.5-1.2,2.7-2.7,2.9C2.1,10,2,10.1,2,10.3V12h1v9H2v1h20v-1h-1v-9h1v-1.7 c0-0.2-0.1-0.3-0.3-0.4C21.2,9.7,20,8.5,20,7C20,5.9,20.6,4.8,21.2,4H20.2z M4,12h2.1c0.5-0.7,1.2-1.3,2-1.7V12H4z M15.9,10.3 c0.8,0.4,1.5,1,2,1.7H20V12h-4.1V10.3z M12,6c1.1,0,2,0.9,2,2s-0.9,2-2,2s-2-0.9-2-2S10.9,6,12,6z"/></svg> <h3>Missão Cumprida!</h3> <p>Você é incrível! O ciclo foi concluído com sucesso e contabilizado. Pronto para o próximo desafio?</p> <div class="modal-buttons"> <button onclick="hideCelebrationModal()">Fechar</button> </div> </div> </div>
    <div id="alertModal" class="modal-overlay"> <div class="modal-content"> <h3 id="alertModalTitle">Atenção</h3> <p id="alertModalMessage"></p> <div class="modal-buttons"> <button onclick="hideAlertModal()">OK</button> </div> </div> </div>
    <div id="confirmModal" class="modal-overlay"> <div class="modal-content"> <h3 id="confirmModalTitle">Confirmar Ação</h3> <p id="confirmModalMessage"></p> <div class="modal-buttons"> <button class="secondary" onclick="hideConfirmModal()">Cancelar</button> <button class="danger" onclick="handleConfirmAction()">Confirmar</button> </div> </div> </div>
    <div id="editDisciplineModal" class="modal-overlay"> <div class="modal-content"> <h3>Editar Disciplina</h3> <input type="hidden" id="editDisciplineId"> <div class="form-group-modal"> <label for="editDisciplineName">Nome da Disciplina</label> <input type="text" id="editDisciplineName"> </div> <div class="form-group-modal"> <label>Meta de Tempo</label> <div class="time-input-container" style="justify-content: center;"> <div class="time-input-group"> <label for="editHoursInput">Horas</label> <input type="number" id="editHoursInput" min="0" placeholder="HH"> </div> <span class="time-input-separator">:</span> <div class="time-input-group"> <label for="editMinutesInput">Minutos</label> <input type="number" id="editMinutesInput" min="0" max="59" step="5" placeholder="MM"> </div> </div> </div> <div class="modal-buttons"> <button class="secondary" onclick="hideEditModal()">Cancelar</button> <button onclick="saveDisciplineChanges()">Salvar Alterações</button> </div> </div> </div>

    <div class="tooltip" id="tooltip" style="position: fixed; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px; pointer-events: none; display: none; z-index: 1000; white-space: nowrap; transition: opacity 0.2s;"></div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDU50I5YKjP-pH8NfCuc59N5_U0rzbeac4",
            authDomain: "ciclo-de-estudo-elias.firebaseapp.com",
            projectId: "ciclo-de-estudo-elias",
            storageBucket: "ciclo-de-estudo-elias.appspot.com",
            messagingSenderId: "1065929930079",
            appId: "1:1065929930079:web:28eaffabc8daeb7ff732ea",
            measurementId: "G-KX8EJZD2CQ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        const COLORS = ['#003366', '#ff6f61', '#28a745', '#ffc107', '#6f42c1', '#17a2b8', '#fd7e14', '#20c997'];
        let appData = { cycles: {}, activeCycleId: null };
        let activeCycle = null;
        let timers = {};
        let currentCalendarDate = new Date();
        let selectedDate = null;
        let unsubscribe;
        let confirmCallback = null;
        let calendarViewMode = 'month';

        async function handleAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    document.querySelector('.main-navigation').style.display = 'flex';
                    await loadUserData(user.uid);
                } else {
                    if (unsubscribe) {
                        unsubscribe();
                        unsubscribe = null; 
                    }
                    activeCycle = null;
                    appData = { cycles: {}, activeCycleId: null };
                    Object.values(timers).forEach(clearInterval);
                    timers = {};

                    document.querySelector('.main-navigation').style.display = 'none';
                    switchView('login');
                }
            });
            try { await auth.getRedirectResult(); } catch (error) { console.error("Auth redirect error:", error); }
        }
        function signInWithGoogle() { auth.signInWithPopup(provider).catch((error) => console.error("Login error:", error)); }
        function signOutUser() { auth.signOut(); }

        async function loadUserData(userId) {
            if (unsubscribe) unsubscribe();
            const userDocRef = db.collection('users').doc(userId);
            try {
                const doc = await userDocRef.get();
                if (!doc.exists) {
                    await userDocRef.set({ cycles: {}, activeCycleId: null });
                }
                unsubscribe = userDocRef.onSnapshot(snapshot => {
                    if (!snapshot.exists) return;
                    appData = snapshot.data();
                    Object.values(timers).forEach(clearInterval);
                    timers = {};
                    if (appData.activeCycleId && appData.cycles[appData.activeCycleId]) {
                        activeCycle = appData.cycles[appData.activeCycleId];
                        switchView('current');
                        updateDisplay();
                    } else {
                        // --- CORREÇÃO 1: LÓGICA DO LISTENER ---
                        // Se não houver ciclo ativo, a interface deve mostrar a tela de seleção.
                        // Não se deve chamar returnToCycleSelection() daqui para evitar loops.
                        activeCycle = null; // Garante que o estado local está limpo.
                        populateCycleSelector();
                        switchView('cycle-selection');
                    }
                }, error => {
                    console.error("Listener error:", error)
                    showAlertModal('Erro de Conexão', 'Não foi possível carregar seus dados. Verifique sua conexão com a internet e tente recarregar a página.');
                });
            } catch (error) {
                 console.error("Error loading user data:", error);
                 showAlertModal('Erro Crítico', 'Não foi possível carregar seus dados. Tente recarregar a página.');
            }
        }

        function saveData() {
            if (auth.currentUser) {
                const userId = auth.currentUser.uid;
                const dataToSave = JSON.parse(JSON.stringify(appData));
                if(dataToSave.activeCycleId && dataToSave.cycles[dataToSave.activeCycleId]) {
                    dataToSave.cycles[dataToSave.activeCycleId].disciplines.forEach(d => d.isRunning = false);
                }
                db.collection('users').doc(userId).set(dataToSave).catch(error => {
                    console.error("Save error:", error);
                    showAlertModal('Erro ao Salvar', 'Não foi possível salvar suas alterações. Verifique sua conexão e tente novamente.');
                });
            }
        }
        
        // --- CORREÇÃO 2: FUNÇÃO PARA TROCAR DE CICLO ---
        function returnToCycleSelection() {
            Object.keys(timers).forEach(id => stopTimer(id, false));
            // Define o ciclo ativo como nulo e salva essa alteração no Firebase.
            // O listener onSnapshot irá reagir a essa mudança e atualizar a interface
            // para a tela de seleção de ciclo.
            if (appData.activeCycleId !== null) {
                appData.activeCycleId = null;
                saveData();
            }
        }

        function populateCycleSelector() {
            const selector = document.getElementById('existingCycleSelector');
            selector.innerHTML = '<option value="">-- Selecione um ciclo --</option>';
            const cycleIds = Object.keys(appData.cycles || {});
            if (cycleIds.length > 0) {
                cycleIds.forEach(id => selector.innerHTML += `<option value="${id}">${id}</option>`);
                selector.disabled = false;
                selector.parentElement.nextElementSibling.disabled = false;
            } else {
                selector.innerHTML = '<option value="">Nenhum ciclo criado</option>';
                selector.disabled = true;
                selector.parentElement.nextElementSibling.disabled = true;
            }
        }

        function loadSelectedCycle() {
            const selectedId = document.getElementById('existingCycleSelector').value;
            if (selectedId && appData.cycles[selectedId]) {
                appData.activeCycleId = selectedId;
                saveData(); // Salva o novo ID. O listener irá carregar a view.
            }
        }
        
        function createNewCycle() {
            const newName = document.getElementById('newCycleNameInput').value.trim();
            if (!newName) { 
                showAlertModal('Nome Inválido', 'Por favor, dê um nome ao novo ciclo.'); 
                return; 
            }
            if (appData.cycles[newName]) { 
                showAlertModal('Nome Duplicado', 'Já existe um ciclo com esse nome. Por favor, escolha outro.'); 
                return; 
            }
            appData.cycles[newName] = { id: newName, disciplines: [], completions: 0, studyHistory: {} };
            appData.activeCycleId = newName;
            saveData();
        }

        function deleteCurrentCycle() {
            if (!activeCycle) return;
            showConfirmModal(
                'Apagar Ciclo',
                `Tem certeza que deseja apagar o ciclo '${activeCycle.id}'? Esta ação é irreversível e removerá todo o histórico associado.`,
                () => {
                    Object.keys(timers).forEach(id => stopTimer(id, false));
                    delete appData.cycles[activeCycle.id];
                    appData.activeCycleId = null;
                    activeCycle = null;
                    saveData(); // A alteração aqui acionará o listener, que levará para a tela de seleção.
                }
            );
        }

        function addDiscipline() {
            if (!activeCycle) return;
            const nameInput = document.getElementById('disciplineInput');
            const hours = parseInt(document.getElementById('hoursInput').value, 10) || 0;
            const minutes = parseInt(document.getElementById('minutesInput').value, 10) || 0;
            const disciplineName = nameInput.value.trim();
            const targetSeconds = (hours * 3600) + (minutes * 60);

            if (!disciplineName || targetSeconds <= 0) { 
                showAlertModal('Dados Inválidos', 'Por favor, insira um nome e uma meta de tempo válida para a disciplina.');
                return; 
            }
            if (activeCycle.disciplines.some(d => d.name.toLowerCase() === disciplineName.toLowerCase())) {
                showAlertModal('Nome Duplicado', 'Já existe uma disciplina com esse nome neste ciclo.');
                return; 
            }

            activeCycle.disciplines.push({ 
                id: Date.now(), 
                name: disciplineName, 
                currentSeconds: 0, 
                targetSeconds: targetSeconds, 
                isRunning: false 
            });
            nameInput.value = '';
            document.getElementById('hoursInput').value = '1';
            document.getElementById('minutesInput').value = '0';
            saveData();
        }
        
        function removeDiscipline(id) {
            if (!activeCycle) return;
            showConfirmModal(
                'Remover Disciplina',
                'Tem certeza que deseja remover esta disciplina?',
                () => {
                    if (timers[id]) stopTimer(id, false);
                    activeCycle.disciplines = activeCycle.disciplines.filter(d => d.id !== id);
                    saveData();
                }
            );
        }
        
        function manuallyEndCycle() {
            if (!activeCycle) return;
            showConfirmModal(
                'Encerrar Ciclo Manualmente',
                'Tem certeza que deseja encerrar este ciclo? Ele será contabilizado como concluído e os tempos de estudo serão zerados para um novo início.',
                () => {
                    hideConfirmModal(); 
                    handleStartNewCycle(); 
                }
            );
        }

        function startTimer(id) {
            if (!activeCycle) return;
            const discipline = activeCycle.disciplines.find(d => d.id === id);
            if (!discipline || discipline.isRunning) return;
            activeCycle.disciplines.forEach(d => { if (d.isRunning) stopTimer(d.id, false); });
            discipline.isRunning = true;
            updateDisciplinesList();
            timers[id] = setInterval(() => {
                discipline.currentSeconds += 1;
                const today = new Date().toISOString().split('T')[0];
                if (!activeCycle.studyHistory[today]) activeCycle.studyHistory[today] = {};
                const discIdStr = String(discipline.id);
                activeCycle.studyHistory[today][discIdStr] = (activeCycle.studyHistory[today][discIdStr] || 0) + 1; 
                updateTimerDisplay(discipline);
            }, 1000);
        }

        function stopTimer(id, doSave = true) {
            if (!activeCycle || !timers[id]) return;
            const discipline = activeCycle.disciplines.find(d => d.id === id);
            clearInterval(timers[id]);
            delete timers[id];
            if (discipline) discipline.isRunning = false;
            
            if (doSave && checkCycleCompletion()) {
                showCompletionModal();
            }
            
            if (doSave) saveData();
            updateDisciplinesList();
        }

        function checkCycleCompletion() {
            if (!activeCycle || activeCycle.disciplines.length === 0) return false;
            return activeCycle.disciplines.every(d => d.currentSeconds >= d.targetSeconds);
        }

        function showCompletionModal() { document.getElementById('completionModal').style.display = 'flex'; }
        function hideCompletionModal() { document.getElementById('completionModal').style.display = 'none'; }

        function handleStartNewCycle() {
            if (!activeCycle) return;
            hideCompletionModal();
            activeCycle.completions = (activeCycle.completions || 0) + 1;
            activeCycle.disciplines.forEach(d => { d.currentSeconds = 0; });
            saveData();
            updateDisplay();
            showCelebrationModal();
        }

        function handleContinueCycle() { hideCompletionModal(); }
        function showCelebrationModal() { document.getElementById('celebrationModal').style.display = 'flex'; }
        function hideCelebrationModal() { document.getElementById('celebrationModal').style.display = 'none'; }

        function showAlertModal(title, message) {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }
        function hideAlertModal() { document.getElementById('alertModal').style.display = 'none'; }

        function showConfirmModal(title, message, callback) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        function hideConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }
        function handleConfirmAction() {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            hideConfirmModal();
        }
        
        function openEditModal(id) {
            const discipline = activeCycle.disciplines.find(d => d.id === id);
            if (!discipline) return;
            
            document.getElementById('editDisciplineId').value = discipline.id;
            document.getElementById('editDisciplineName').value = discipline.name;

            const hours = Math.floor(discipline.targetSeconds / 3600);
            const minutes = Math.floor((discipline.targetSeconds % 3600) / 60);
            document.getElementById('editHoursInput').value = hours;
            document.getElementById('editMinutesInput').value = minutes;

            document.getElementById('editDisciplineModal').style.display = 'flex';
        }

        function hideEditModal() {
            document.getElementById('editDisciplineModal').style.display = 'none';
        }

        function saveDisciplineChanges() {
            const id = parseInt(document.getElementById('editDisciplineId').value, 10);
            const newName = document.getElementById('editDisciplineName').value.trim();
            const newHours = parseInt(document.getElementById('editHoursInput').value, 10) || 0;
            const newMinutes = parseInt(document.getElementById('editMinutesInput').value, 10) || 0;
            const newTargetSeconds = (newHours * 3600) + (newMinutes * 60);

            if (!newName || newTargetSeconds <= 0) {
                showAlertModal('Dados Inválidos', 'O nome não pode estar em branco e a meta de tempo deve ser maior que zero.');
                return;
            }

            const discipline = activeCycle.disciplines.find(d => d.id === id);
            if (discipline) {
                discipline.name = newName;
                discipline.targetSeconds = newTargetSeconds;
                saveData();
                updateDisplay();
                hideEditModal();
            }
        }

        function toggleTimer(id) {
            const discipline = activeCycle.disciplines.find(d => d.id === id);
            if (discipline.isRunning) stopTimer(id);
            else startTimer(id);
        }

        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');
            const nav = document.querySelector('.main-navigation');
            if (viewName === 'login' || viewName === 'cycle-selection' || viewName === 'loading') {
                nav.style.display = 'none';
            } else {
                nav.style.display = 'flex';
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                const activeTab = document.querySelector(`[onclick="switchView('${viewName}')"]`);
                if(activeTab) activeTab.classList.add('active');
            }
            if (viewName === 'calendar') { renderCalendar(); } 
            if (viewName === 'history') { updateHistoryView(); }
        }

        function updateDisplay() {
            if (!activeCycle) return;
            document.getElementById('cycleTitle').innerHTML = `<svg class="cycle-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256 256-114.6 256-256S399.4 0 256 0zm0 464C141.1 464 48 370.9 48 256S141.1 48 256 48s208 93.1 208 208-93.1 208-208 208zm-62.5-133.3l105.3-43.9 43.9-105.3-105.3 43.9-43.9 105.3z"/></svg> <span>Ciclo ${activeCycle.id}</span>`;
            updateStats();
            updateDisciplinesList();
            createWheelChart();
        }
        
        function updateStats() {
            if (!activeCycle) return;
            document.getElementById('cycleCompletions').textContent = activeCycle.completions || 0;
            document.getElementById('totalDisciplines').textContent = activeCycle.disciplines.length;
            const today = new Date().toISOString().split('T')[0];
            let totalSecondsToday = 0;
            if(appData.cycles){
                Object.values(appData.cycles).forEach(cycle => {
                    if (cycle.studyHistory && cycle.studyHistory[today]) {
                         totalSecondsToday += Object.values(cycle.studyHistory[today]).reduce((sum, s) => sum + s, 0);
                    }
                });
            }
            document.getElementById('totalHours').textContent = formatTime(totalSecondsToday);
        }

        function updateDisciplinesList() {
            if (!activeCycle) return;
            const listEl = document.getElementById('disciplinesList');
            if (!listEl) return;
            listEl.innerHTML = activeCycle.disciplines.map((d, i) => {
                const isCompleted = d.targetSeconds > 0 && d.currentSeconds >= d.targetSeconds;
                return `
                    <div class="discipline-item ${isCompleted ? 'completed' : ''}" id="discipline-${d.id}" style="border-left-color: ${COLORS[i % COLORS.length]};">
                        <div class="discipline-name-group">
                            <button class="edit-btn" title="Editar disciplina" onclick="openEditModal(${d.id})"><span class="material-icons-outlined">edit</span></button>
                            <span>${d.name}</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 100px;">
                            <span class="time-current">${formatTime(d.currentSeconds)}</span>
                            <span style="font-size: 12px; color: #666;">Meta: ${formatTime(d.targetSeconds)}</span>
                        </div>
                        <div class="timer-controls" style="display:flex; gap:8px; align-items:center;">
                            <button class="timer-btn ${d.isRunning ? 'stop' : ''}" onclick="toggleTimer(${d.id})">${d.isRunning ? 'Pausar' : 'Iniciar'}</button>
                            <button class="remove-btn secondary" onclick="removeDiscipline(${d.id})">Remover</button>
                        </div>
                    </div>`;
            }).join('');
        }
        
        function updateTimerDisplay(discipline) {
            const itemEl = document.getElementById(`discipline-${discipline.id}`);
            if (!itemEl) return;
            itemEl.querySelector('.time-current').textContent = formatTime(discipline.currentSeconds);
            const isCompleted = discipline.targetSeconds > 0 && discipline.currentSeconds >= discipline.targetSeconds;
            if(isCompleted) { itemEl.classList.add('completed'); } 
            else { itemEl.classList.remove('completed'); }
            updateStats();
        }

        function createWheelChart() {
            const svg = document.getElementById('wheelChart');
            const tooltip = document.getElementById('tooltip');
            svg.innerHTML = ''; 
            if (!activeCycle || activeCycle.disciplines.length === 0) {
                svg.innerHTML = `<text x="200" y="200" text-anchor="middle" font-size="16">Adicione disciplinas para começar</text>`;
                return;
            }
            
            const totalStudied = activeCycle.disciplines.reduce((sum, d) => sum + d.currentSeconds, 0);
            const totalTarget = activeCycle.disciplines.reduce((sum, d) => sum + d.targetSeconds, 0);
            let startAngle = -90;
            const gapDegrees = 2;

            activeCycle.disciplines.forEach((d, i) => {
                let sliceAngle = totalTarget > 0 ? (d.targetSeconds / totalTarget) * 360 : 360 / activeCycle.disciplines.length;
                let endAngle = startAngle + sliceAngle;

                if (sliceAngle > gapDegrees) {
                    const arcStart = startAngle + gapDegrees / 2;
                    const arcEnd = endAngle - gapDegrees / 2;
                    const path = createArc(200, 200, 150, 90, arcStart, arcEnd);
                    path.setAttribute("fill", COLORS[i % COLORS.length]);
                    path.addEventListener('mouseover', (e) => {
                        tooltip.innerHTML = `<strong>${d.name}</strong><br>Estudado: ${formatTime(d.currentSeconds)}<br>Meta: ${formatTime(d.targetSeconds)}`;
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${e.clientX + 15}px`;
                        tooltip.style.top = `${e.clientY - 10}px`;
                    });
                    path.addEventListener('mouseout', () => { tooltip.style.display = 'none'; });
                    svg.appendChild(path);
                }
                startAngle = endAngle;
            });

            const svgNS = "http://www.w3.org/2000/svg";
            function createText(x, y, content, size, weight, color, opacity = 1) {
                const textEl = document.createElementNS(svgNS, "text");
                textEl.setAttribute("x", x); textEl.setAttribute("y", y);
                textEl.setAttribute("text-anchor", "middle");
                textEl.setAttribute("font-size", size);
                if (weight) textEl.setAttribute("font-weight", weight);
                textEl.setAttribute("fill", color);
                textEl.setAttribute("opacity", opacity);
                textEl.textContent = content;
                return textEl;
            }
            
            svg.appendChild(createText("200", "185", "Estudei", "18", "500", "#6c757d"));
            svg.appendChild(createText("200", "215", formatTime(totalStudied), "28", "600", "#003366"));
            svg.appendChild(createText("200", "238", `de ${formatTime(totalTarget)}`, "16", "500", "#6c757d", 0.8));
        }

        function createArc(x, y, outerR, innerR, start, end) {
            if (end - start >= 360) end = start + 359.99;
            const startRad = (start * Math.PI) / 180, endRad = (end * Math.PI) / 180;
            const largeArc = (end - start) > 180 ? 1 : 0;
            const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const d = ["M",x + outerR * Math.cos(startRad),y + outerR * Math.sin(startRad),"A",outerR,outerR,0,largeArc,1,x + outerR * Math.cos(endRad),y + outerR * Math.sin(endRad),"L",x + innerR * Math.cos(endRad),y + innerR * Math.sin(endRad),"A",innerR,innerR,0,largeArc,0,x + innerR * Math.cos(startRad),y + innerR * Math.sin(startRad),"Z"].join(" ");
            p.setAttribute("d", d);
            return p;
        }
        
        function setCalendarView(mode) {
            calendarViewMode = mode;
            document.getElementById('view-toggle-month').classList.toggle('active', mode === 'month');
            document.getElementById('view-toggle-week').classList.toggle('active', mode === 'week');
            renderCalendar();
        }

        function navigateCalendar(direction) {
            if (calendarViewMode === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            } else {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + (direction * 7));
            }
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const titleEl = document.getElementById('calendarTitle');
            const summaryEl = document.getElementById('calendar-summary');
            grid.innerHTML = '';
            
            const allHistories = Object.values(appData.cycles).map(c => c.studyHistory).filter(Boolean);

            if (calendarViewMode === 'month') {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                titleEl.textContent = `${currentCalendarDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}`;
                
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let monthlyTotalSeconds = 0;

                for (let i = 0; i < firstDayOfMonth; i++) { grid.insertAdjacentHTML('beforeend', '<div></div>'); }

                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    const isoDate = date.toISOString().split('T')[0];
                    let dailyTotal = 0;
                    allHistories.forEach(history => {
                        if (history[isoDate]) {
                            dailyTotal += Object.values(history[isoDate]).reduce((sum, s) => sum + s, 0);
                        }
                    });
                    monthlyTotalSeconds += dailyTotal;

                    let classes = 'calendar-day';
                    if (isoDate === new Date().toISOString().split('T')[0]) classes += ' today';
                    if (selectedDate === isoDate) classes += ' selected';
                    if (dailyTotal > 0) classes += ' has-studies';
                    grid.insertAdjacentHTML('beforeend', `<div class="${classes}" onclick="selectDate('${isoDate}')">${i}</div>`);
                }
                summaryEl.innerHTML = `Total no Mês: <strong>${formatTime(monthlyTotalSeconds)}</strong>`;

            } else { // 'week' view
                const weekStart = new Date(currentCalendarDate);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                titleEl.textContent = `${weekStart.toLocaleDateString('pt-BR')} - ${weekEnd.toLocaleDateString('pt-BR')}`;
                let weeklyTotalSeconds = 0;

                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(date.getDate() + i);
                    const isoDate = date.toISOString().split('T')[0];
                    let dailyTotal = 0;
                     allHistories.forEach(history => {
                        if (history[isoDate]) {
                            dailyTotal += Object.values(history[isoDate]).reduce((sum, s) => sum + s, 0);
                        }
                    });
                    weeklyTotalSeconds += dailyTotal;

                    let classes = 'calendar-day';
                    if (isoDate === new Date().toISOString().split('T')[0]) classes += ' today';
                    if (selectedDate === isoDate) classes += ' selected';
                    if (dailyTotal > 0) classes += ' has-studies';
                    grid.insertAdjacentHTML('beforeend', `<div class="${classes}" onclick="selectDate('${isoDate}')">${date.getDate()}</div>`);
                }
                 summaryEl.innerHTML = `Total na Semana: <strong>${formatTime(weeklyTotalSeconds)}</strong>`;
            }
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            renderCalendar(); 
            const infoEl = document.getElementById('selectedDateInfo');
            
            let dailyTotalSeconds = 0;
            let html = `<h4 style="color: #003366; font-weight: 600;">Estudos de ${new Date(dateStr + 'T12:00:00').toLocaleDateString('pt-BR')}</h4>`;
            let studiesFound = false;

            Object.values(appData.cycles).forEach(cycle => {
                if (cycle.studyHistory && cycle.studyHistory[dateStr]) {
                    Object.entries(cycle.studyHistory[dateStr]).forEach(([discId, seconds]) => {
                        const discipline = cycle.disciplines.find(d => d.id == discId);
                        if (discipline) {
                            html += `<div class="study-history-item"> <span><strong>${discipline.name}</strong> (${cycle.id}): ${formatTime(seconds)}</span> <button class="history-delete-btn" title="Apagar este registro" onclick="deleteHistoryEntry('${dateStr}', '${cycle.id}', '${discId}')">X</button> </div>`;
                            studiesFound = true;
                            dailyTotalSeconds += seconds;
                        }
                    });
                }
            });

            const summaryHtml = `<div class="daily-total"><strong>Total do Dia:</strong> ${formatTime(dailyTotalSeconds)}</div>`;

            if (!studiesFound) {
                html += `<p style="margin-top: 10px;">Nenhum estudo registrado para este dia.</p>`;
                infoEl.innerHTML = html;
            } else {
                infoEl.innerHTML = summaryHtml + html;
            }
            infoEl.style.display = 'block';
        }
        
        function deleteHistoryEntry(dateStr, cycleId, disciplineId) {
            showConfirmModal('Apagar Registro', 'Tem certeza que deseja apagar este registro de estudo? O tempo total da disciplina será recalculado.', () => {
                const cycle = appData.cycles[cycleId];
                if (!cycle || !cycle.studyHistory || !cycle.studyHistory[dateStr] || !cycle.studyHistory[dateStr][disciplineId]) return;
                const secondsToDelete = cycle.studyHistory[dateStr][disciplineId];
                const discipline = cycle.disciplines.find(d => String(d.id) === disciplineId);
                if (discipline) {
                    discipline.currentSeconds -= secondsToDelete;
                    if (discipline.currentSeconds < 0) discipline.currentSeconds = 0;
                }
                delete cycle.studyHistory[dateStr][disciplineId];
                if (Object.keys(cycle.studyHistory[dateStr]).length === 0) {
                    delete cycle.studyHistory[dateStr];
                }
                saveData();
                selectDate(dateStr); 
                if (activeCycle && activeCycle.id === cycleId) updateDisplay();
            });
        }

        function updateHistoryView() {
            const selector = document.getElementById('historyCycleSelector');
            const selectedValue = selector.value;
            selector.innerHTML = '<option value="geral">Geral (Todos os Ciclos)</option>';
            Object.keys(appData.cycles).forEach(id => {
                selector.innerHTML += `<option value="${id}">${id}</option>`;
            });
            selector.value = selectedValue || 'geral';
            updateHistoryStats();
        }
        function updateHistoryStats() {
            const selectedId = document.getElementById('historyCycleSelector').value;
            const statsContainer = document.getElementById('historyStats');
            let totalSeconds = 0, studyDays = new Set(), completions = 0;
            const cyclesToProcess = selectedId === 'geral' ? Object.values(appData.cycles) : (appData.cycles[selectedId] ? [appData.cycles[selectedId]] : []);
            cyclesToProcess.forEach(cycle => {
                if (!cycle) return;
                completions += cycle.completions || 0;
                if (cycle.studyHistory) {
                    Object.entries(cycle.studyHistory).forEach(([date, disciplines]) => {
                        studyDays.add(date);
                        totalSeconds += Object.values(disciplines).reduce((sum, s) => sum + s, 0);
                    });
                }
            });
            statsContainer.innerHTML = `<div class="stat-card"><div class="stat-number">${formatTime(totalSeconds)}</div><div class="stat-label">Total de Horas</div></div> <div class="stat-card"><div class="stat-number">${studyDays.size}</div><div class="stat-label">Dias de Estudo</div></div> <div class="stat-card"><div class="stat-number">${completions}</div><div class="stat-label">Ciclos Concluídos</div></div>`;
        }

        function formatTime(totalSeconds) {
            totalSeconds = Math.round(totalSeconds || 0);
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = Math.floor(totalSeconds % 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        
        handleAuth();
    </script>
</body>
</html>
