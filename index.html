<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Ciclo de Estudos Sincronizado</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .app-shell { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .main-navigation { display: flex; gap: 20px; margin-bottom: 30px; padding-left: 10px; }
        .nav-tab { background: none; border: none; color: rgba(255, 255, 255, 0.7); font-size: 18px; cursor: pointer; padding-bottom: 8px; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .nav-tab:hover { color: white; }
        .nav-tab.active { color: white; font-weight: bold; border-bottom-color: white; }
        .view { display: none; }
        .view.active { display: block; }
        
        /* --- Telas de Carregando e Login --- */
        .fullscreen-view { text-align: center; padding: 60px 20px; background: white; border-radius: 20px; max-width: 500px; margin: 80px auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .fullscreen-view h2 { margin-bottom: 15px; font-size: 2em; color: #333; }
        .fullscreen-view p { margin-bottom: 30px; color: #666; }
        #login-button { display: inline-flex; align-items: center; gap: 15px; padding: 15px 30px; font-size: 18px; background: #4285F4; border-radius: 50px; }
        #login-button svg { width: 24px; height: 24px; }

        #current-view .container { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        #current-view h1 { text-align: center; color: #333; margin-bottom: 30px; font-size: 2.5em; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        #cycle-selection-view { text-align: center; padding: 40px 20px; background: white; border-radius: 20px; max-width: 600px; margin: 40px auto; }
        #cycle-selection-view h2 { margin-bottom: 20px; }
        #cycle-selection-view .form-group { margin-bottom: 20px; text-align: left; }
        #cycle-selection-view label { display: block; margin-bottom: 5px; font-weight: bold; }
        #cycle-selection-view select, #cycle-selection-view input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; }
        #cycle-selection-view .or-divider { margin: 25px 0; font-weight: bold; color: #999; }
        .page-header { font-size: 2em; color: white; font-weight: bold; margin-bottom: 30px; display: flex; align-items: center; gap: 15px; padding-left: 10px; }
        .content-wrapper { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        #historyCycleSelector { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; margin-bottom: 30px; }
        .controls { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; align-items: center; }
        .input-group { flex: 1; min-width: 200px; }
        .input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: #667eea; }
        .time-input-container { display: flex; gap: 10px; align-items: flex-end; }
        .time-input-group { display: flex; flex-direction: column; align-items: center; }
        .time-input-group label { font-size: 0.8em; color: #666; margin-bottom: 4px; }
        .time-input-group input { width: 70px; text-align: center; }
        .time-input-separator { font-size: 1.5em; color: #999; padding-bottom: 10px; }
        button { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-size: 16px; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .chart-container { background: linear-gradient(45deg, #3494E6, #EC6EAD, #2196F3, #9C27B0); background-size: 400% 400%; animation: flow 10s ease infinite; border-radius: 20px; padding: 20px; margin: 20px 0; display: flex; justify-content: center; position: relative; }
        @keyframes flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0; text-align: center; }
        .stat-card { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .discipline-list { margin: 20px 0; }
        .discipline-item { display: flex; align-items: center; gap: 15px; padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 10px; transition: all 0.3s; flex-wrap: wrap; border-left: 4px solid; }
        .discipline-item.completed { background: #e7f3ff; }
        .discipline-name { flex: 1; font-weight: 500; min-width: 150px; }
        .time-display { display: flex; flex-direction: column; align-items: center; min-width: 100px; }
        .time-current { font-size: 18px; font-weight: bold; color: #333; }
        .time-target { font-size: 12px; color: #666; }
        .time-progress { width: 100px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin: 5px 0; }
        .time-progress-fill { height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); transition: width 0.3s ease; }
        .time-progress-fill.completed { background: linear-gradient(45deg, #28a745, #20c997); }
        .timer-controls { display: flex; gap: 8px; align-items: center; }
        .timer-btn { background: linear-gradient(45deg, #28a745, #20c997); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold; min-width: 60px; margin-right: 5px; }
        .timer-btn.stop { background: linear-gradient(45deg, #dc3545, #c82333); }
        .timer-btn:hover { transform: translateY(-1px); }
        .timer-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .remove-btn { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .success-message { background: linear-gradient(45deg, #28a745, #20c997); color: white; padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0; font-weight: bold; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 20px; }
        .calendar-day-header { text-align: center; font-weight: bold; padding-bottom: 10px; color: #666; }
        .calendar-day { aspect-ratio: 1; border: 1px solid #e9e9e9; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; position: relative; font-size: 14px; }
        .calendar-day:hover { background: #f0f0f0; border-color: #ddd; }
        .calendar-day.today { border-color: #667eea; font-weight: bold; }
        .calendar-day.selected { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-color: #667eea; font-weight: bold; }
        .calendar-day.has-studies { background: #e7f3ff; }
        .calendar-day.has-studies::after { content: ''; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background-color: #667eea; border-radius: 50%; }
        .study-history { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .history-item { padding: 10px; margin: 5px 0; background: white; border-radius: 8px; border-left: 4px solid #667eea; }
        .history-date { font-weight: bold; color: #333; margin-bottom: 5px; }
        .history-disciplines { color: #666; font-size: 14px; }
        .empty-state { text-align: center; color: #666; font-style: italic; padding: 40px; }
        .cycle-progress { background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 20px 0; }
        .progress-bar { background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden; margin: 10px 0; }
        .progress-fill { background: linear-gradient(45deg, #667eea, #764ba2); height: 100%; transition: width 0.3s ease; }
        .progress-text { text-align: center; margin: 10px 0; font-weight: bold; color: #333; }
        .add-discipline-form { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .form-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .running-timer { display: inline-block; background: linear-gradient(45deg, #28a745, #20c997); color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        #cycleDecision { display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; }
        #cycleDecision button { margin: 0 10px; padding: 10px 20px; }
        .tooltip { position: fixed; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px; pointer-events: none; display: none; z-index: 1000; white-space: nowrap; transition: opacity 0.2s; }
        .history-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .history-stat-card { background: linear-gradient(135deg, #f5f7fa, #c3cfe2); color: #333; padding: 20px; border-radius: 15px; text-align: center; }
        .history-stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; color: #667eea; }
        .history-stat-label { font-size: 0.9em; opacity: 0.9; }
    </style>
</head>
<body>

    <div class="app-shell">
        <nav class="main-navigation" style="display: none;">
            <button class="nav-tab active" onclick="switchView('current')">Ciclo Atual</button>
            <button class="nav-tab" onclick="switchView('calendar')">Calendário</button>
            <button class="nav-tab" onclick="switchView('history')">Histórico</button>
        </nav>

        <div id="loading-view" class="view active fullscreen-view">
            <h2>Carregando...</h2>
            <p>Verificando sua autenticação.</p>
        </div>

        <div id="login-view" class="view fullscreen-view">
            <h2>Bem-vindo ao seu Rastreador de Estudos</h2>
            <p>Faça login com sua conta Google para salvar e sincronizar seus ciclos de estudo em todos os seus dispositivos.</p>
            <button id="login-button" onclick="signInWithGoogle()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.223,0-9.651-3.358-11.303-8H6.306C9.656,39.663,16.318,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.901,35.636,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                <span>Entrar com Google</span>
            </button>
        </div>

        <div id="cycle-selection-view" class="view">
            <h2>Selecione ou Crie um Ciclo</h2>
            <div class="form-group">
                <label for="existingCycleSelector">Escolha um ciclo existente</label>
                <select id="existingCycleSelector"></select>
            </div>
            <button onclick="loadSelectedCycle()">Carregar Ciclo</button>
            <div class="or-divider">OU</div>
            <div class="form-group">
                 <label for="newCycleNameInput">Crie um novo ciclo</label>
                 <input type="text" id="newCycleNameInput" placeholder="Nome do novo ciclo...">
            </div>
            <button onclick="createNewCycle()">Criar e Iniciar</button>
        </div>


        <div id="current-view" class="view">
            <div class="container">
                <h1 id="cycleTitle"></h1>
                <div id="main-content">
                    <div class="stats">
                        <div class="stat-card"><div class="stat-number" id="cycleCompletions">0</div><div class="stat-label">Vezes Concluído</div></div>
                        <div class="stat-card"><div class="stat-number" id="totalDisciplines">0</div><div class="stat-label">Disciplinas</div></div>
                        <div class="stat-card"><div class="stat-number" id="totalHours">0h</div><div class="stat-label">Horas Hoje</div></div>
                    </div>
                    <div class="cycle-progress"><div class="progress-text">Progresso do Ciclo</div><div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div><div id="progressText" class="progress-text"></div></div>
                    <div class="add-discipline-form">
                        <div class="form-title">➕ Adicionar Nova Disciplina</div>
                        <div class="input-row">
                            <div class="input-group"><input type="text" id="disciplineInput" placeholder="Nome da disciplina..."></div>
                            <div class="time-input-container">
                                <div class="time-input-group">
                                    <label for="hoursInput">Horas</label>
                                    <input type="number" id="hoursInput" min="0" placeholder="HH" value="2">
                                </div>
                                <span class="time-input-separator">:</span>
                                <div class="time-input-group">
                                    <label for="minutesInput">Minutos</label>
                                    <input type="number" id="minutesInput" min="0" max="59" step="5" placeholder="MM" value="0">
                                </div>
                            </div>
                            <button onclick="addDiscipline()">Adicionar</button>
                        </div>
                    </div>
                    
                    <div class="controls" id="mainControls">
                        <button onclick="returnToCycleSelection()">Trocar de Ciclo</button>
                        <button onclick="exportAllData()">Exportar Tudo</button>
                        <button onclick="signOutUser()" style="background: linear-gradient(45deg, #dc3545, #c82333);">Sair</button>
                    </div>
                    
                    <div id="successMessage" class="success-message" style="display: none;">🎉 Ciclo completo! Parabéns!</div>
                    
                    <div id="cycleDecision" style="display: none;">
                        <p>Todas as disciplinas atingiram suas metas mínimas! O que deseja fazer?</p>
                        <button onclick="startNewCycle()">Escolher Outro Ciclo</button>
                        <button onclick="continueCurrentCycle()">Continuar no Ciclo Atual</button>
                    </div>

                    <div class="chart-container" id="chartContainer"><svg id="wheelChart" width="400" height="400" viewBox="0 0 400 400"></svg></div>
                    <div class="discipline-list" id="disciplinesList"></div>
                </div>
            </div>
        </div>

        <div id="calendar-view" class="view">
            <header class="page-header">📅 Calendário de Estudos</header>
            <div class="content-wrapper">
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)">❮</button>
                    <h2 id="currentMonth"></h2>
                    <button class="calendar-nav" onclick="changeMonth(1)">❯</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Dom</div><div class="calendar-day-header">Seg</div><div class="calendar-day-header">Ter</div><div class="calendar-day-header">Qua</div><div class="calendar-day-header">Qui</div><div class="calendar-day-header">Sex</div><div class="calendar-day-header">Sáb</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div id="selectedDateInfo" class="study-history" style="display: none;"></div>
            </div>
        </div>

        <div id="history-view" class="view">
            <header class="page-header">📜 Histórico de Estudos</header>
            <div class="content-wrapper">
                <select id="historyCycleSelector" onchange="updateHistoryStats()"></select>
                <div class="history-stats" id="historyStats"></div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDU50I5YKjP-pH8NfCuc59N5_U0rzbeac4",
            authDomain: "ciclo-de-estudo-elias.firebaseapp.com",
            projectId: "ciclo-de-estudo-elias",
            storageBucket: "ciclo-de-estudo-elias.appspot.com",
            messagingSenderId: "1065929930079",
            appId: "1:1065929930079:web:28eaffabc8daeb7ff732ea",
            measurementId: "G-KX8EJZD2CQ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        const COLORS = ['#3498DB', '#E74C3C', '#27AE60', '#F1C40F', '#9B59B6', '#E67E22', '#2ECC71', '#D35400', '#8E44AD', '#16A085'];
        let appData = { cycles: {}, activeCycleId: null };
        let activeCycle = null;
        let timers = {};
        let currentCalendarDate = new Date();
        let selectedDate = null;
        let unsubscribe;

        auth.onAuthStateChanged(user => {
            if (user) {
                loadUserData(user.uid);
            } else {
                switchView('login');
                if(unsubscribe) unsubscribe();
            }
        });

        function signInWithGoogle() {
            auth.signInWithRedirect(provider);
        }

        function signOutUser() {
            auth.signOut();
        }
        
        auth.getRedirectResult()
            .then((result) => {
                if (result.user) {
                    // O onAuthStateChanged vai lidar com a lógica principal.
                }
            }).catch((error) => {
                console.error("Erro no getRedirectResult:", error);
            });

        async function loadUserData(userId) {
            if (unsubscribe) unsubscribe();
            
            const userDocRef = db.collection('users').doc(userId);
            
            const doc = await userDocRef.get().catch(err => console.error("Erro ao buscar documento:", err));
            
            if (!doc.exists) {
                appData = { cycles: {}, activeCycleId: null };
                await userDocRef.set(appData).catch(err => console.error("Erro ao criar documento:", err));
            }
            
            unsubscribe = userDocRef.onSnapshot(snapshot => {
                if (!snapshot.exists) return; // Guarda contra exclusão de doc
                appData = snapshot.data();
                
                Object.values(timers).forEach(clearInterval);
                timers = {};

                if (appData.activeCycleId && appData.cycles[appData.activeCycleId]) {
                    activeCycle = appData.cycles[appData.activeCycleId];
                    switchView('current');
                    updateDisplay();
                } else {
                    returnToCycleSelection();
                }
            }, error => {
                console.error("Erro no listener de dados:", error);
                alert("Não foi possível carregar seus dados em tempo real.");
            });
        }

        function saveData() {
            if (auth.currentUser) {
                const userId = auth.currentUser.uid;
                const dataToSave = JSON.parse(JSON.stringify(appData));
                if(dataToSave.activeCycleId && dataToSave.cycles[dataToSave.activeCycleId]) {
                    dataToSave.cycles[dataToSave.activeCycleId].disciplines.forEach(d => d.isRunning = false);
                }
                db.collection('users').doc(userId).set(dataToSave).catch(error => console.error("Erro ao salvar:", error));
            }
        }
        
        function returnToCycleSelection() {
            Object.keys(timers).forEach(id => stopTimer(id, false));
            activeCycle = null;
            appData.activeCycleId = null;
            saveData();
            populateCycleSelector();
            switchView('cycle-selection');
        }

        function populateCycleSelector() {
            const selector = document.getElementById('existingCycleSelector');
            selector.innerHTML = '<option value="">-- Selecione --</option>';
            const cycleIds = Object.keys(appData.cycles);
            if (cycleIds.length > 0) {
                cycleIds.forEach(id => selector.innerHTML += `<option value="${id}">${id}</option>`);
                selector.disabled = false;
                selector.parentElement.nextElementSibling.disabled = false;
            } else {
                selector.innerHTML = '<option value="">Nenhum ciclo criado</option>';
                selector.disabled = true;
                selector.parentElement.nextElementSibling.disabled = true;
            }
        }

        function loadSelectedCycle() {
            const selectedId = document.getElementById('existingCycleSelector').value;
            if (selectedId && appData.cycles[selectedId]) {
                appData.activeCycleId = selectedId;
                activeCycle = appData.cycles[selectedId];
                saveData();
                switchView('current');
                updateDisplay();
            }
        }
        
        function createNewCycle() {
            const newName = document.getElementById('newCycleNameInput').value.trim();
            if (!newName) { alert("Por favor, dê um nome ao novo ciclo."); return; }
            if (appData.cycles[newName]) { alert("Já existe um ciclo com esse nome."); return; }

            appData.cycles[newName] = { id: newName, disciplines: [], completions: 0, studyHistory: {} };
            appData.activeCycleId = newName;
            activeCycle = appData.cycles[newName];
            saveData();
            switchView('current');
            updateDisplay();
        }

        function addDiscipline() {
            if (!activeCycle) return;
            const nameInput = document.getElementById('disciplineInput');
            const hours = parseInt(document.getElementById('hoursInput').value, 10) || 0;
            const minutes = parseInt(document.getElementById('minutesInput').value, 10) || 0;
            const disciplineName = nameInput.value.trim();
            const targetHours = hours + (minutes / 60);

            if (!disciplineName || targetHours <= 0) { alert('Por favor, insira um nome e uma meta de tempo válida (maior que 0).'); return; }
            if (activeCycle.disciplines.some(d => d.name.toLowerCase() === disciplineName.toLowerCase())) { alert('Já existe uma disciplina com esse nome neste ciclo.'); return; }

            activeCycle.disciplines.push({ id: Date.now(), name: disciplineName, currentHours: 0, targetHours: targetHours, isRunning: false });
            nameInput.value = '';
            document.getElementById('hoursInput').value = '2';
            document.getElementById('minutesInput').value = '0';
            saveData();
        }
        
        function removeDiscipline(id) {
            if (!activeCycle) return;
            if (timers[id]) stopTimer(id);
            activeCycle.disciplines = activeCycle.disciplines.filter(d => d.id !== id);
            saveData();
        }
        
        function completeActiveCycle() {
            if (!activeCycle) return;
            activeCycle.completions = (activeCycle.completions || 0) + 1;
            activeCycle.disciplines.forEach(d => { d.currentHours = 0; });
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            setTimeout(() => { successMsg.style.display = 'none'; }, 3000);
            saveData();
        }

        function startNewCycle() {
            completeActiveCycle();
            setTimeout(returnToCycleSelection, 1000);
        }
        
        function continueCurrentCycle() {
            document.getElementById('cycleDecision').style.display = 'none';
            document.getElementById('mainControls').style.display = 'flex';
        }
        
        function exportAllData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ciclos-de-estudo-backup-${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function startTimer(id) {
            if (!activeCycle) return;
            const discipline = activeCycle.disciplines.find(d => d.id === id);
            if (!discipline || discipline.isRunning) return;

            activeCycle.disciplines.forEach(d => { if (d.isRunning) stopTimer(d.id); });

            discipline.isRunning = true;
            updateDisciplinesList();
            
            timers[id] = setInterval(() => {
                discipline.currentHours += 1 / 3600;
                const today = new Date().toISOString().split('T')[0];
                if (!activeCycle.studyHistory[today]) activeCycle.studyHistory[today] = {};
                activeCycle.studyHistory[today][id] = (activeCycle.studyHistory[today][id] || 0) + (1 / 3600);
                
                updateTimerDisplay(discipline);
            }, 1000);
        }

        function stopTimer(id, doSave = true) {
            if (!activeCycle || !timers[id]) return;
            const discipline = activeCycle.disciplines.find(d => d.id === id);
            
            clearInterval(timers[id]);
            delete timers[id];
            
            if (discipline) discipline.isRunning = false;
            
            updateDisciplinesList();
            updateProgress();
            checkCycleCompletion();
            if (doSave) saveData();
        }
        
        function toggleTimer(id) {
            const discipline = activeCycle.disciplines.find(d => d.id === id);
            if (discipline.isRunning) {
                stopTimer(id);
            } else {
                startTimer(id);
            }
        }

        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');
            const nav = document.querySelector('.main-navigation');
            if (viewName === 'login' || viewName === 'cycle-selection' || viewName === 'loading') {
                nav.style.display = 'none';
            } else {
                nav.style.display = 'flex';
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[onclick="switchView('${viewName}')"]`).classList.add('active');
            }
            if (viewName === 'calendar') updateCalendar();
            if (viewName === 'history') updateHistoryView();
        }

        function updateDisplay() {
            if (!activeCycle) return;
            document.getElementById('cycleTitle').innerHTML = `📚 Ciclo ${activeCycle.id}`;
            updateStats();
            updateProgress();
            updateDisciplinesList();
            createWheelChart();
            checkCycleCompletion();
        }
        
        function updateStats() {
            document.getElementById('cycleCompletions').textContent = activeCycle.completions || 0;
            document.getElementById('totalDisciplines').textContent = activeCycle.disciplines.length;
            const today = new Date().toISOString().split('T')[0];
            const todayStudies = (activeCycle && activeCycle.studyHistory[today]) || {};
            const totalHoursToday = Object.values(todayStudies).reduce((sum, h) => sum + h, 0);
            document.getElementById('totalHours').textContent = formatTime(totalHoursToday);
        }

        function updateProgress() {
            if (!activeCycle) return;
            const completedCount = activeCycle.disciplines.filter(d => d.currentHours >= d.targetHours).length;
            const total = activeCycle.disciplines.length;
            const percentage = total > 0 ? (completedCount / total) * 100 : 0;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completedCount} de ${total} disciplinas concluídas`;
        }
        
        function checkCycleCompletion() {
            if (!activeCycle) return;
            const allGoalsMet = activeCycle.disciplines.length > 0 && activeCycle.disciplines.every(d => d.currentHours >= d.targetHours);
            const anyTimerRunning = Object.values(timers).length > 0;
            if (allGoalsMet && !anyTimerRunning) {
                document.getElementById('mainControls').style.display = 'none';
                document.getElementById('cycleDecision').style.display = 'block';
            } else {
                document.getElementById('mainControls').style.display = 'flex';
                document.getElementById('cycleDecision').style.display = 'none';
            }
        }
        
        function updateDisciplinesList() {
            if (!activeCycle) return;
            const listEl = document.getElementById('disciplinesList');
            if (!listEl) return;
            listEl.innerHTML = activeCycle.disciplines.map((d, i) => {
                const progress = d.targetHours > 0 ? Math.min((d.currentHours / d.targetHours) * 100, 100) : 0;
                return `
                    <div class="discipline-item ${progress >= 100 ? 'completed' : ''}" id="discipline-${d.id}" style="border-left-color: ${COLORS[i % COLORS.length]};">
                        <span class="discipline-name">${d.name}</span>
                        <div class="time-display">
                            <span class="time-current">${formatTime(d.currentHours)}</span>
                            <span class="time-target">Meta: ${formatTime(d.targetHours)}</span>
                            <div class="time-progress"><div class="time-progress-fill ${progress >= 100 ? 'completed' : ''}" style="width: ${progress}%"></div></div>
                        </div>
                        <div class="timer-controls">
                            <button class="timer-btn ${d.isRunning ? 'stop' : ''}" onclick="toggleTimer(${d.id})">${d.isRunning ? 'Pausar' : 'Iniciar'}</button>
                            <button class="remove-btn" onclick="removeDiscipline(${d.id})">Remover</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateTimerDisplay(discipline) {
            const itemEl = document.getElementById(`discipline-${discipline.id}`);
            if (!itemEl) return;
            itemEl.querySelector('.time-current').textContent = formatTime(discipline.currentHours);
            const progress = discipline.targetHours > 0 ? Math.min((discipline.currentHours / discipline.targetHours) * 100, 100) : 0;
            const progressFill = itemEl.querySelector('.time-progress-fill');
            progressFill.style.width = `${progress}%`;
            if (progress >= 100 && !itemEl.classList.contains('completed')) {
                itemEl.classList.add('completed');
                progressFill.classList.add('completed');
            }
            updateStats();
        }

        function createWheelChart() {
            const svg = document.getElementById('wheelChart');
            const tooltip = document.getElementById('tooltip');
            svg.innerHTML = ''; 

            if (!activeCycle || activeCycle.disciplines.length === 0) {
                svg.innerHTML = `<text x="200" y="200" text-anchor="middle" fill="white" font-size="16">Adicione disciplinas para começar</text>`;
                return;
            }

            const totalTarget = activeCycle.disciplines.reduce((sum, d) => sum + d.targetHours, 0);
            const totalStudied = activeCycle.disciplines.reduce((sum, d) => sum + d.currentHours, 0);
            
            let startAngle = -90;
            activeCycle.disciplines.forEach((d, i) => {
                let sliceAngle = totalTarget > 0 ? (d.targetHours / totalTarget) * 360 : 360 / activeCycle.disciplines.length;
                if (sliceAngle >= 360) sliceAngle = 359.99;
                
                const endAngle = startAngle + sliceAngle;
                const path = createArc(200, 200, 150, 60, startAngle, endAngle);
                path.setAttribute("fill", COLORS[i % COLORS.length]);
                
                path.addEventListener('mouseover', () => {
                    tooltip.innerHTML = `<strong>${d.name}</strong><br>Estudado: ${formatTime(d.currentHours)}<br>Meta: ${formatTime(d.targetHours)}`;
                    tooltip.style.display = 'block';
                });
                path.addEventListener('mousemove', (e) => {
                    tooltip.style.left = `${e.clientX + 15}px`;
                    tooltip.style.top = `${e.clientY - 10}px`;
                });
                path.addEventListener('mouseout', () => { tooltip.style.display = 'none'; });

                svg.appendChild(path);
                startAngle = endAngle;
            });
            
            const svgNS = "http://www.w3.org/2000/svg";
            const innerCircle = document.createElementNS(svgNS, "circle");
            innerCircle.setAttribute("cx", "200"); innerCircle.setAttribute("cy", "200"); innerCircle.setAttribute("r", "60"); innerCircle.setAttribute("fill", "white");
            svg.appendChild(innerCircle);

            function createText(x, y, content, size, weight, color) {
                const textEl = document.createElementNS(svgNS, "text");
                textEl.setAttribute("x", x); textEl.setAttribute("y", y);
                textEl.setAttribute("text-anchor", "middle"); textEl.setAttribute("font-size", size);
                if (weight) textEl.setAttribute("font-weight", weight);
                textEl.setAttribute("fill", color); textEl.textContent = content;
                return textEl;
            }

            svg.appendChild(createText("200", "188", "Estudei", "16", "bold", "#333"));
            svg.appendChild(createText("200", "212", formatTime(totalStudied), "20", null, "#666"));
            svg.appendChild(createText("200", "232", `de ${formatTime(totalTarget)}`, "14", null, "#666"));
        }
        
        function createArc(x, y, outerR, innerR, start, end) {
            const startRad = (start * Math.PI) / 180, endRad = (end * Math.PI) / 180;
            const largeArc = (end - start) > 180 ? 1 : 0;
            const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const d = ["M",x + outerR * Math.cos(startRad),y + outerR * Math.sin(startRad),"A",outerR,outerR,0,largeArc,1,x + outerR * Math.cos(endRad),y + outerR * Math.sin(endRad),"L",x + innerR * Math.cos(endRad),y + innerR * Math.sin(endRad),"A",innerR,innerR,0,largeArc,0,x + innerR * Math.cos(startRad),y + innerR * Math.sin(startRad),"Z"].join(" ");
            p.setAttribute("d", d);
            return p;
        }
        
        function updateCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();
            document.getElementById('currentMonth').textContent = `${currentCalendarDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                grid.insertAdjacentHTML('beforeend', '<div></div>');
            }
            
            const allHistories = Object.values(appData.cycles).map(c => c.studyHistory);

            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month, i);
                const isoDate = date.toISOString().split('T')[0];
                const isToday = isoDate === new Date().toISOString().split('T')[0];
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (selectedDate === isoDate) classes += ' selected';
                
                const hasStudies = allHistories.some(history => history[isoDate]);
                if (hasStudies) classes += ' has-studies';

                grid.insertAdjacentHTML('beforeend', `<div class="${classes}" onclick="selectDate('${isoDate}')">${i}</div>`);
            }
        }

        function changeMonth(dir) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + dir);
            updateCalendar();
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            updateCalendar();
            const infoEl = document.getElementById('selectedDateInfo');
            let html = `<h4>Estudos do dia ${new Date(dateStr + 'T12:00:00').toLocaleDateString('pt-BR')}</h4>`;
            let studiesFound = false;

            Object.values(appData.cycles).forEach(cycle => {
                if (cycle.studyHistory[dateStr]) {
                    Object.entries(cycle.studyHistory[dateStr]).forEach(([discId, hours]) => {
                        const discipline = cycle.disciplines.find(d => d.id == discId);
                        if (discipline) {
                            html += `<div class="history-item"><strong>${discipline.name}</strong> (${cycle.id}): ${formatTime(hours)}</div>`;
                            studiesFound = true;
                        }
                    });
                }
            });
            
            if (!studiesFound) {
                html += `<p>Nenhum estudo registrado para este dia.</p>`;
            }
            infoEl.innerHTML = html;
            infoEl.style.display = 'block';
        }

        function updateHistoryView() {
            const selector = document.getElementById('historyCycleSelector');
            const selectedValue = selector.value;
            selector.innerHTML = '<option value="geral">Geral (Todos os Ciclos)</option>';
            Object.keys(appData.cycles).forEach(id => {
                selector.innerHTML += `<option value="${id}">${id}</option>`;
            });
            selector.value = selectedValue || 'geral';
            updateHistoryStats();
        }

        function updateHistoryStats() {
            const selectedId = document.getElementById('historyCycleSelector').value;
            const statsContainer = document.getElementById('historyStats');
            
            let totalHours = 0, studyDays = new Set(), completions = 0;

            if (selectedId === 'geral') {
                Object.values(appData.cycles).forEach(cycle => {
                    completions += cycle.completions || 0;
                    Object.entries(cycle.studyHistory).forEach(([date, disciplines]) => {
                        studyDays.add(date);
                        totalHours += Object.values(disciplines).reduce((sum, h) => sum + h, 0);
                    });
                });
            } else if (appData.cycles[selectedId]) {
                const cycle = appData.cycles[selectedId];
                completions = cycle.completions || 0;
                Object.entries(cycle.studyHistory).forEach(([date, disciplines]) => {
                    studyDays.add(date);
                    totalHours += Object.values(disciplines).reduce((sum, h) => sum + h, 0);
                });
            }
            
            statsContainer.innerHTML = `
                <div class="history-stat-card"><div class="history-stat-number">${formatTime(totalHours)}</div><div class="history-stat-label">Total de Horas</div></div>
                <div class="history-stat-card"><div class="history-stat-number">${studyDays.size}</div><div class="history-stat-label">Dias de Estudo</div></div>
                <div class="history-stat-card"><div class="history-stat-number">${completions}</div><div class="history-stat-label">Vezes Concluído</div></div>
            `;
        }

        function formatTime(hours) {
            hours = hours || 0;
            const h = Math.floor(hours);
            const m = Math.floor((hours * 60) % 60);
            const s = Math.floor((hours * 3600) % 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        
    </script>
</body>
</html>
