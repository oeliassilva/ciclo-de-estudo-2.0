<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareerPath | Ciclo de Estudos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <style>
        /* --- ESTILO BASE INSPIRADO NA CAREERPATH --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            /* Fonte e cor de fundo principais da CareerPath */
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa; /* Um cinza muito claro, como no dashboard */
            color: #2c3e50; /* Um azul escuro/cinza para o texto */
            min-height: 100vh;
        }
        .app-shell { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* --- NAVEGAÇÃO PRINCIPAL --- */
        .main-navigation { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 30px; 
            padding-left: 10px; 
            border-bottom: 1px solid #dee2e6; /* Linha sutil para separar */
        }
        .nav-tab { 
            background: none; 
            border: none; 
            color: #6c757d; /* Cinza para abas inativas */
            font-size: 18px; 
            font-weight: 500;
            cursor: pointer; 
            padding-bottom: 12px; 
            border-bottom: 3px solid transparent; 
            transition: all 0.3s ease; 
        }
        .nav-tab:hover { color: #003366; } /* Azul escuro do logo */
        .nav-tab.active { 
            color: #003366; /* Azul escuro do logo */
            font-weight: 600; 
            border-bottom-color: #003366; 
        }
        .view { display: none; }
        .view.active { display: block; }
        
        /* --- TELAS DE TELA CHEIA (LOGIN, CARREGANDO) --- */
        .fullscreen-view { 
            text-align: center; 
            padding: 60px 20px; 
            background: white; 
            border-radius: 12px; 
            max-width: 550px; 
            margin: 60px auto; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            border: 1px solid #e9ecef;
        }
        .fullscreen-view h2 { margin-bottom: 15px; font-size: 1.8em; color: #003366; }
        .fullscreen-view p { margin-bottom: 30px; color: #6c757d; line-height: 1.6; }
        #login-button { 
            display: inline-flex; 
            align-items: center; 
            gap: 15px; 
            padding: 12px 28px; 
            font-size: 16px; 
            font-weight: 500;
            background: #4285F4; /* Cor padrão do Google */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #login-button:hover { background-color: #357ae8; }
        #login-button svg { width: 20px; height: 20px; }

        /* --- ESTILOS DE CONTEÚDO PRINCIPAL --- */
        .content-wrapper, #current-view .container { 
            background: white; 
            border-radius: 12px; 
            padding: 30px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }
        .page-header { 
            font-size: 2em; 
            color: #003366; /* Azul escuro do logo */
            font-weight: 600; 
            margin-bottom: 30px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding-left: 10px; 
        }
        .page-header .material-icons-outlined { font-size: 1.2em; } /* Ajusta tamanho dos ícones do header */

        /* Título do ciclo (substituindo o gradiente) */
        #current-view h1 {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            text-align: center;
            color: #003366; /* Azul escuro do logo */
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 600;
        }
        .cycle-icon { /* Classe para o ícone de bússola SVG */
            width: 1.1em;
            height: 1.1em;
            fill: #ff6f61; /* Laranja/coral da agulha da bússola */
        }

        /* --- BOTÕES E INPUTS --- */
        button { 
            background-color: #003366; /* Azul escuro do logo */
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 15px;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0, 51, 102, 0.2); 
        }
        button:disabled { 
            background-color: #aeb8c2;
            opacity: 1;
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none;
        }
        input[type="text"], input[type="number"], select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ced4da; 
            border-radius: 8px; 
            font-size: 16px; 
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s; 
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus { 
            outline: none; 
            border-color: #ff6f61; /* Laranja da agulha */
            box-shadow: 0 0 0 3px rgba(255, 111, 97, 0.2);
        }
        .remove-btn, button.secondary {
            background-color: #e9ecef;
            color: #495057;
        }
        .remove-btn:hover, button.secondary:hover {
             background-color: #dee2e6;
             box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        button.danger {
            background-color: #e74c3c;
        }
         button.danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        /* --- GRÁFICO E STATS --- */
        .chart-container { 
            background-color: #fff;
            border: 1px solid #e9ecef;
            border-radius: 12px; 
            padding: 20px; 
            margin: 20px 0; 
            display: flex; 
            justify-content: center; 
            position: relative; 
        }
        #wheelChart text { fill: #6c757d; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { 
            background-color: #fff;
            border: 1px solid #e9ecef;
            color: #2c3e50; 
            padding: 20px; 
            border-radius: 12px; 
            text-align: center;
        }
        .stat-number { font-size: 2em; font-weight: 600; color: #003366; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; color: #6c757d; }

        /* --- LISTA DE DISCIPLINAS --- */
        .discipline-list { margin: 20px 0; }
        .discipline-item { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 15px; 
            margin: 10px 0; 
            background: #fdfdff; 
            border-radius: 10px; 
            border: 1px solid #e9ecef;
            transition: all 0.3s; 
            flex-wrap: wrap; 
            border-left: 5px solid; 
        }
        .discipline-item.completed { border-left-color: #28a745 !important; background-color: #f6fff8; }
        .time-progress-fill { background-color: #003366; } /* Azul escuro */
        .time-progress-fill.completed { background-color: #28a745; }
        .timer-btn { background-color: #28a745; font-size: 14px; padding: 10px 16px; }
        .timer-btn.stop { background-color: #ff6f61; } /* Laranja */
        
        /* --- CALENDÁRIO --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-header { text-align: center; font-weight: 600; color: #6c757d; font-size: 0.9em; padding-bottom: 10px; }
        .calendar-day { aspect-ratio: 1; border: 1px solid transparent; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; position: relative; font-size: 14px; }
        .calendar-day:hover { background-color: #f0f3f5; }
        .calendar-day.today { border-color: #ff6f61; }
        .calendar-day.selected { background-color: #003366; color: white; }
        .calendar-day.has-studies { font-weight: 600; }
        .calendar-day.has-studies::after { content: ''; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background-color: #003366; border-radius: 50%; }
        .calendar-day.selected.has-studies::after { background-color: #ff6f61; }
        .calendar-nav { background-color: #003366; }
        .study-history { border-top: 1px solid #dee2e6; margin-top: 20px; padding-top: 20px; }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* --- OUTROS --- */
        #cycle-selection-view { text-align: center; background: white; border-radius: 12px; padding: 40px 20px; max-width: 600px; margin: 40px auto; border: 1px solid #e9ecef; }
        .add-discipline-form { background: #f8f9fa; border: 1px solid #e9ecef; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .form-title { font-size: 1.2em; font-weight: 600; margin-bottom: 15px; color: #003366; }
        .input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .time-input-container { display: flex; gap: 10px; align-items: flex-end; }
        .time-input-group { display: flex; flex-direction: column; align-items: center; }
        .time-input-group label { font-size: 0.8em; color: #666; margin-bottom: 4px; }
        .time-input-group input { width: 70px; text-align: center; }
        .time-input-separator { font-size: 1.5em; color: #999; padding-bottom: 10px; }

        /* Media queries para responsividade */
        @media (max-width: 600px) {
            .add-discipline-form .input-row { flex-wrap: wrap; gap: 15px; }
            .add-discipline-form .input-group { width: 100%; min-width: 100%; }
            .add-discipline-form .time-input-container { flex-grow: 1; }
            .add-discipline-form button { flex-grow: 1; }
            body { padding: 5px; }
            .app-shell { padding: 10px; }
            .content-wrapper, #current-view .container, .fullscreen-view { padding: 15px; }
            .page-header { font-size: 1.5em; }
        }
    </style>
</head>
<body>

    <div class="app-shell">
        <nav class="main-navigation" style="display: none;">
            <button class="nav-tab active" onclick="switchView('current')">Ciclo Atual</button>
            <button class="nav-tab" onclick="switchView('calendar')">Calendário</button>
            <button class="nav-tab" onclick="switchView('history')">Histórico</button>
        </nav>

        <div id="loading-view" class="view active fullscreen-view">
            <h2>Carregando...</h2>
            <p>Verificando sua conta CareerPath.</p>
        </div>

        <div id="login-view" class="view fullscreen-view">
            <h2>Bem-vindo ao seu Ciclo de Estudos</h2>
            <p>Faça login com sua conta Google para salvar e sincronizar seus ciclos de estudo na plataforma CareerPath.</p>
            <button id="login-button" onclick="signInWithGoogle()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.223,0-9.651-3.358-11.303-8H6.306C9.656,39.663,16.318,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.901,35.636,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                <span>Entrar com Google</span>
            </button>
        </div>

        <div id="cycle-selection-view" class="view">
            <h2>Selecione ou Crie um Ciclo</h2>
            <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                <label for="existingCycleSelector" style="display: block; margin-bottom: 8px; font-weight: 500;">Escolha um ciclo existente</label>
                <select id="existingCycleSelector"></select>
            </div>
            <button onclick="loadSelectedCycle()">Carregar Ciclo</button>
            <div style="margin: 25px 0; font-weight: bold; color: #999;">OU</div>
            <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                 <label for="newCycleNameInput" style="display: block; margin-bottom: 8px; font-weight: 500;">Crie um novo ciclo</label>
                 <input type="text" id="newCycleNameInput" placeholder="Ex: Trilha Front-End...">
            </div>
            <button onclick="createNewCycle()">Criar e Iniciar</button>
        </div>

        <div id="current-view" class="view">
            <div class="container">
                <h1 id="cycleTitle"></h1>
                <div id="main-content">
                    <div class="stats">
                        <div class="stat-card"><div class="stat-number" id="cycleCompletions">0</div><div class="stat-label">Vezes Concluído</div></div>
                        <div class="stat-card"><div class="stat-number" id="totalDisciplines">0</div><div class="stat-label">Disciplinas</div></div>
                        <div class="stat-card"><div class="stat-number" id="totalHours">0h</div><div class="stat-label">Horas Hoje</div></div>
                    </div>
                    
                    <div class="add-discipline-form">
                        <div class="form-title">Adicionar Nova Disciplina</div>
                        <div class="input-row">
                            <div class="input-group"><input type="text" id="disciplineInput" placeholder="Nome da disciplina..."></div>
                            <div class="time-input-container">
                                <div class="time-input-group">
                                    <label for="hoursInput">Horas</label>
                                    <input type="number" id="hoursInput" min="0" placeholder="HH" value="2">
                                </div>
                                <span class="time-input-separator">:</span>
                                <div class="time-input-group">
                                    <label for="minutesInput">Minutos</label>
                                    <input type="number" id="minutesInput" min="0" max="59" step="5" placeholder="MM" value="0">
                                </div>
                            </div>
                            <button onclick="addDiscipline()">Adicionar</button>
                        </div>
                    </div>

                    <div class="chart-container" id="chartContainer"><svg id="wheelChart" width="400" height="400" viewBox="0 0 400 400"></svg></div>
                    <div class="discipline-list" id="disciplinesList"></div>

                    <div id="mainControls" style="display:flex; gap:10px; margin-top:30px; justify-content:center;">
                        <button class="secondary" onclick="returnToCycleSelection()">Trocar de Ciclo</button>
                        <button class="secondary" onclick="exportAllData()">Exportar Dados</button>
                        <button class="danger" onclick="signOutUser()">Sair</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="calendar-view" class="view">
            <header class="page-header"><span class="material-icons-outlined">calendar_today</span> Calendário de Estudos</header>
            <div class="content-wrapper">
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)">❮</button>
                    <h2 id="currentMonth" style="color: #003366; font-weight: 600;"></h2>
                    <button class="calendar-nav" onclick="changeMonth(1)">❯</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Dom</div><div class="calendar-day-header">Seg</div><div class="calendar-day-header">Ter</div><div class="calendar-day-header">Qua</div><div class="calendar-day-header">Qui</div><div class="calendar-day-header">Sex</div><div class="calendar-day-header">Sáb</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div id="selectedDateInfo" class="study-history" style="display: none;"></div>
            </div>
        </div>

        <div id="history-view" class="view">
            <header class="page-header"><span class="material-icons-outlined">bar_chart</span> Histórico de Estudos</header>
            <div class="content-wrapper">
                <select id="historyCycleSelector" onchange="updateHistoryStats()"></select>
                <div id="historyStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;"></div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip" style="position: fixed; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px; pointer-events: none; display: none; z-index: 1000; white-space: nowrap; transition: opacity 0.2s;"></div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDU50I5YKjP-pH8NfCuc59N5_U0rzbeac4",
            authDomain: "ciclo-de-estudo-elias.firebaseapp.com",
            projectId: "ciclo-de-estudo-elias",
            storageBucket: "ciclo-de-estudo-elias.appspot.com",
            messagingSenderId: "1065929930079",
            appId: "1:1065929930079:web:28eaffabc8daeb7ff732ea",
            measurementId: "G-KX8EJZD2CQ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        const COLORS = ['#003366', '#ff6f61', '#28a745', '#ffc107', '#6f42c1', '#17a2b8', '#fd7e14', '#20c997'];
        let appData = { cycles: {}, activeCycleId: null };
        let activeCycle = null;
        let timers = {};
        let currentCalendarDate = new Date();
        let selectedDate = null;
        let unsubscribe;

        async function handleAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    document.querySelector('.main-navigation').style.display = 'flex';
                    await loadUserData(user.uid);
                } else {
                    document.querySelector('.main-navigation').style.display = 'none';
                    switchView('login');
                }
            });
            try {
                await auth.getRedirectResult();
            } catch (error) {
                console.error("Erro ao processar o resultado do redirecionamento:", error);
            }
        }

        function signInWithGoogle() {
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log("Login com popup concluído com sucesso!", result.user);
                })
                .catch((error) => {
                    console.error("Erro durante o login com popup:", error);
                    alert("Ocorreu um erro durante o login: " + error.message);
                });
        }

        function signOutUser() {
            auth.signOut();
        }

        async function loadUserData(userId) {
            if (unsubscribe) unsubscribe();
            const userDocRef = db.collection('users').doc(userId);
            try {
                const doc = await userDocRef.get();
                if (!doc.exists) {
                    await userDocRef.set({ cycles: {}, activeCycleId: null });
                }
                unsubscribe = userDocRef.onSnapshot(snapshot => {
                    if (!snapshot.exists) {
                        console.error("User document deleted.");
                        return;
                    } 
                    appData = snapshot.data();
                    Object.values(timers).forEach(clearInterval);
                    timers = {};
                    if (appData.activeCycleId && appData.cycles[appData.activeCycleId]) {
                        activeCycle = appData.cycles[appData.activeCycleId];
                        switchView('current');
                        updateDisplay();
                    } else {
                        returnToCycleSelection();
                    }
                }, error => console.error("Erro no listener de dados:", error));
            } catch (error) {
                 console.error("Erro ao carregar ou criar dados do usuário:", error);
                 alert("Não foi possível carregar seus dados. Tente recarregar a página.");
            }
        }

        function saveData() {
            if (auth.currentUser) {
                const userId = auth.currentUser.uid;
                const dataToSave = JSON.parse(JSON.stringify(appData));
                if(dataToSave.activeCycleId && dataToSave.cycles[dataToSave.activeCycleId]) {
                    dataToSave.cycles[dataToSave.activeCycleId].disciplines.forEach(d => d.isRunning = false);
                }
                db.collection('users').doc(userId).set(dataToSave).catch(error => console.error("Erro ao salvar:", error));
            }
        }
        
        function returnToCycleSelection() {
            Object.keys(timers).forEach(id => stopTimer(id, false));
            activeCycle = null;
            appData.activeCycleId = null;
            populateCycleSelector();
            switchView('cycle-selection');
        }

        function populateCycleSelector() {
            const selector = document.getElementById('existingCycleSelector');
            selector.innerHTML = '<option value="">-- Selecione um ciclo --</option>';
            const cycleIds = Object.keys(appData.cycles);
            if (cycleIds.length > 0) {
                cycleIds.forEach(id => selector.innerHTML += `<option value="${id}">${id}</option>`);
                selector.disabled = false;
                selector.parentElement.nextElementSibling.disabled = false;
            } else {
                selector.innerHTML = '<option value="">Nenhum ciclo criado</option>';
                selector.disabled = true;
                selector.parentElement.nextElementSibling.disabled = true;
            }
        }

        function loadSelectedCycle() {
            const selectedId = document.getElementById('existingCycleSelector').value;
            if (selectedId && appData.cycles[selectedId]) {
                appData.activeCycleId = selectedId;
                saveData();
            }
        }
        
        function createNewCycle() {
            const newName = document.getElementById('newCycleNameInput').value.trim();
            if (!newName) { alert("Por favor, dê um nome ao novo ciclo."); return; }
            if (appData.cycles[newName]) { alert("Já existe um ciclo com esse nome."); return; }
            appData.cycles[newName] = { id: newName, disciplines: [], completions: 0, studyHistory: {} };
            appData.activeCycleId = newName;
            saveData();
        }

        function addDiscipline() {
            if (!activeCycle) return;
            const nameInput = document.getElementById('disciplineInput');
            const hours = parseInt(document.getElementById('hoursInput').value, 10) || 0;
            const minutes = parseInt(document.getElementById('minutesInput').value, 10) || 0;
            const disciplineName = nameInput.value.trim();
            const targetHours = hours + (minutes / 60);
            if (!disciplineName || targetHours <= 0) { alert('Por favor, insira um nome e uma meta de tempo válida.'); return; }
            if (activeCycle.disciplines.some(d => d.name.toLowerCase() === disciplineName.toLowerCase())) { alert('Já existe uma disciplina com esse nome.'); return; }
            activeCycle.disciplines.push({ id: Date.now(), name: disciplineName, currentHours: 0, targetHours: targetHours, isRunning: false });
            nameInput.value = '';
            document.getElementById('hoursInput').value = '2';
            document.getElementById('minutesInput').value = '0';
            saveData();
        }
        
        function removeDiscipline(id) {
            if (!activeCycle) return;
            if (timers[id]) stopTimer(id);
            activeCycle.disciplines = activeCycle.disciplines.filter(d => d.id !== id);
            saveData();
        }
        
        function startTimer(id) {
            if (!activeCycle) return;
            const discipline = activeCycle.disciplines.find(d => d.id === id);
            if (!discipline || discipline.isRunning) return;
            activeCycle.disciplines.forEach(d => { if (d.isRunning) stopTimer(d.id); });
            discipline.isRunning = true;
            updateDisciplinesList();
            timers[id] = setInterval(() => {
                discipline.currentHours += 1 / 3600;
                const today = new Date().toISOString().split('T')[0];
                if (!activeCycle.studyHistory[today]) activeCycle.studyHistory[today] = {};
                activeCycle.studyHistory[today][id] = (activeCycle.studyHistory[today][id] || 0) + (1 / 3600);
                updateTimerDisplay(discipline);
            }, 1000);
        }

        function stopTimer(id, doSave = true) {
            if (!activeCycle || !timers[id]) return;
            const discipline = activeCycle.disciplines.find(d => d.id === id);
            clearInterval(timers[id]);
            delete timers[id];
            if (discipline) discipline.isRunning = false;
            if (doSave) saveData();
            updateDisciplinesList();
        }
        
        function toggleTimer(id) {
            const discipline = activeCycle.disciplines.find(d => d.id === id);
            if (discipline.isRunning) stopTimer(id);
            else startTimer(id);
        }

        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');
            const nav = document.querySelector('.main-navigation');
            if (viewName === 'login' || viewName === 'cycle-selection' || viewName === 'loading') {
                nav.style.display = 'none';
            } else {
                nav.style.display = 'flex';
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[onclick="switchView('${viewName}')"]`).classList.add('active');
            }
            if (viewName === 'calendar') updateCalendar();
            if (viewName === 'history') updateHistoryView();
        }

        function updateDisplay() {
            if (!activeCycle) return;
            document.getElementById('cycleTitle').innerHTML = `
                <svg class="cycle-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256 256-114.6 256-256S399.4 0 256 0zm0 464C141.1 464 48 370.9 48 256S141.1 48 256 48s208 93.1 208 208-93.1 208-208 208zm-62.5-133.3l105.3-43.9 43.9-105.3-105.3 43.9-43.9 105.3z"/></svg>
                <span>Ciclo ${activeCycle.id}</span>`;
            updateStats();
            updateProgress();
            updateDisciplinesList();
            createWheelChart();
        }
        
        function updateStats() {
            if (!activeCycle) return;
            document.getElementById('cycleCompletions').textContent = activeCycle.completions || 0;
            document.getElementById('totalDisciplines').textContent = activeCycle.disciplines.length;
            const today = new Date().toISOString().split('T')[0];
            const todayStudies = (activeCycle && activeCycle.studyHistory[today]) || {};
            const totalHoursToday = Object.values(todayStudies).reduce((sum, h) => sum + h, 0);
            document.getElementById('totalHours').textContent = formatTime(totalHoursToday);
        }

        function updateProgress() {
            // Esta função foi removida pois não há elementos com estes IDs no novo HTML
        }
        
        function updateDisciplinesList() {
            if (!activeCycle) return;
            const listEl = document.getElementById('disciplinesList');
            if (!listEl) return;
            listEl.innerHTML = activeCycle.disciplines.map((d, i) => {
                const progress = d.targetHours > 0 ? Math.min((d.currentHours / d.targetHours) * 100, 100) : 0;
                return `
                    <div class="discipline-item ${progress >= 100 ? 'completed' : ''}" id="discipline-${d.id}" style="border-left-color: ${COLORS[i % COLORS.length]};">
                        <span style="flex: 1; font-weight: 500; min-width: 150px;">${d.name}</span>
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 100px;">
                            <span class="time-current">${formatTime(d.currentHours)}</span>
                            <span style="font-size: 12px; color: #666;">Meta: ${formatTime(d.targetHours)}</span>
                        </div>
                        <div class="timer-controls" style="display:flex; gap:8px; align-items:center;">
                            <button class="timer-btn ${d.isRunning ? 'stop' : ''}" onclick="toggleTimer(${d.id})">${d.isRunning ? 'Pausar' : 'Iniciar'}</button>
                            <button class="remove-btn secondary" onclick="removeDiscipline(${d.id})">Remover</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateTimerDisplay(discipline) {
            const itemEl = document.getElementById(`discipline-${discipline.id}`);
            if (!itemEl) return;
            itemEl.querySelector('.time-current').textContent = formatTime(discipline.currentHours);
            updateStats();
        }

        function createWheelChart() {
            const svg = document.getElementById('wheelChart');
            const tooltip = document.getElementById('tooltip');
            svg.innerHTML = ''; 
            if (!activeCycle || activeCycle.disciplines.length === 0) {
                svg.innerHTML = `<text x="200" y="200" text-anchor="middle" font-size="16">Adicione disciplinas para começar</text>`;
                return;
            }
            const totalTarget = activeCycle.disciplines.reduce((sum, d) => sum + d.targetHours, 0);
            const totalStudied = activeCycle.disciplines.reduce((sum, d) => sum + d.currentHours, 0);
            let startAngle = -90;
            activeCycle.disciplines.forEach((d, i) => {
                let sliceAngle = totalTarget > 0 ? (d.targetHours / totalTarget) * 360 : 360 / activeCycle.disciplines.length;
                if (sliceAngle >= 360) sliceAngle = 359.99;
                const endAngle = startAngle + sliceAngle;
                const path = createArc(200, 200, 150, 90, startAngle, endAngle);
                path.setAttribute("fill", COLORS[i % COLORS.length]);
                path.addEventListener('mouseover', (e) => {
                    tooltip.innerHTML = `<strong>${d.name}</strong><br>Estudado: ${formatTime(d.currentHours)}<br>Meta: ${formatTime(d.targetHours)}`;
                    tooltip.style.display = 'block';
                    tooltip.style.left = `${e.clientX + 15}px`;
                    tooltip.style.top = `${e.clientY - 10}px`;
                });
                path.addEventListener('mouseout', () => { tooltip.style.display = 'none'; });
                svg.appendChild(path);
                startAngle = endAngle;
            });
            const svgNS = "http://www.w3.org/2000/svg";
            function createText(x, y, content, size, weight, color) {
                const textEl = document.createElementNS(svgNS, "text");
                textEl.setAttribute("x", x); textEl.setAttribute("y", y);
                textEl.setAttribute("text-anchor", "middle"); textEl.setAttribute("font-size", size);
                if (weight) textEl.setAttribute("font-weight", weight);
                textEl.setAttribute("fill", color); textEl.textContent = content;
                return textEl;
            }
            svg.appendChild(createText("200", "195", "Total Estudado", "18", "600", "#003366"));
            svg.appendChild(createText("200", "225", formatTime(totalStudied), "24", "500", "#2c3e50"));
        }
        
        function createArc(x, y, outerR, innerR, start, end) {
            const startRad = (start * Math.PI) / 180, endRad = (end * Math.PI) / 180;
            const largeArc = (end - start) > 180 ? 1 : 0;
            const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const d = ["M",x + outerR * Math.cos(startRad),y + outerR * Math.sin(startRad),"A",outerR,outerR,0,largeArc,1,x + outerR * Math.cos(endRad),y + outerR * Math.sin(endRad),"L",x + innerR * Math.cos(endRad),y + innerR * Math.sin(endRad),"A",innerR,innerR,0,largeArc,0,x + innerR * Math.cos(startRad),y + innerR * Math.sin(startRad),"Z"].join(" ");
            p.setAttribute("d", d);
            return p;
        }
        
        function updateCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();
            document.getElementById('currentMonth').textContent = `${currentCalendarDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) { grid.insertAdjacentHTML('beforeend', '<div></div>'); }
            const allHistories = Object.values(appData.cycles).map(c => c.studyHistory);
            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month, i);
                const isoDate = date.toISOString().split('T')[0];
                let classes = 'calendar-day';
                if (isoDate === new Date().toISOString().split('T')[0]) classes += ' today';
                if (selectedDate === isoDate) classes += ' selected';
                if (allHistories.some(history => history[isoDate])) classes += ' has-studies';
                grid.insertAdjacentHTML('beforeend', `<div class="${classes}" onclick="selectDate('${isoDate}')">${i}</div>`);
            }
        }

        function changeMonth(dir) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + dir);
            updateCalendar();
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            updateCalendar();
            const infoEl = document.getElementById('selectedDateInfo');
            let html = `<h4 style="color: #003366; font-weight: 600;">Estudos de ${new Date(dateStr + 'T12:00:00').toLocaleDateString('pt-BR')}</h4>`;
            let studiesFound = false;
            Object.values(appData.cycles).forEach(cycle => {
                if (cycle.studyHistory && cycle.studyHistory[dateStr]) {
                    Object.entries(cycle.studyHistory[dateStr]).forEach(([discId, hours]) => {
                        const discipline = cycle.disciplines.find(d => d.id == discId);
                        if (discipline) {
                            html += `<div style="padding: 8px; margin-top: 5px; background: #fdfdff; border-left: 3px solid #003366; border-radius: 4px;"><strong>${discipline.name}</strong> (${cycle.id}): ${formatTime(hours)}</div>`;
                            studiesFound = true;
                        }
                    });
                }
            });
            if (!studiesFound) html += `<p style="margin-top: 10px;">Nenhum estudo registrado para este dia.</p>`;
            infoEl.innerHTML = html;
            infoEl.style.display = 'block';
        }

        function updateHistoryView() {
            const selector = document.getElementById('historyCycleSelector');
            const selectedValue = selector.value;
            selector.innerHTML = '<option value="geral">Geral (Todos os Ciclos)</option>';
            Object.keys(appData.cycles).forEach(id => {
                selector.innerHTML += `<option value="${id}">${id}</option>`;
            });
            selector.value = selectedValue || 'geral';
            updateHistoryStats();
        }

        function updateHistoryStats() {
            const selectedId = document.getElementById('historyCycleSelector').value;
            const statsContainer = document.getElementById('historyStats');
            let totalHours = 0, studyDays = new Set(), completions = 0;
            const cyclesToProcess = selectedId === 'geral' ? Object.values(appData.cycles) : [appData.cycles[selectedId]];
            cyclesToProcess.forEach(cycle => {
                if (!cycle) return;
                completions += cycle.completions || 0;
                if (cycle.studyHistory) {
                    Object.entries(cycle.studyHistory).forEach(([date, disciplines]) => {
                        studyDays.add(date);
                        totalHours += Object.values(disciplines).reduce((sum, h) => sum + h, 0);
                    });
                }
            });
            statsContainer.innerHTML = `
                <div class="stat-card"><div class="stat-number">${formatTime(totalHours)}</div><div class="stat-label">Total de Horas</div></div>
                <div class="stat-card"><div class="stat-number">${studyDays.size}</div><div class="stat-label">Dias de Estudo</div></div>
                <div class="stat-card"><div class="stat-number">${completions}</div><div class="stat-label">Ciclos Concluídos</div></div>`;
        }

        function formatTime(hours) {
            hours = hours || 0;
            const h = Math.floor(hours);
            const m = Math.floor((hours * 60) % 60);
            const s = Math.floor((hours * 3600) % 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        
        // Inicializa o fluxo de autenticação quando o script é carregado
        handleAuth();
    </script>
</body>
</html>
